# Service

## 김현수

### 서비스란?

**Service는 백그라운드 작업을 위한 애플리케이션 구성 요소이다.**

Activity가 사용자에게 직접 보이는 화면이라면 Service는 뒤에서 수행된다.

ex) 음악 재생, 파일 입출력, 네트워크 트랜잭션 처리 등

### 서비스의 3가지 유형

1) 백그라운드

    백그라운드는 이름 그대로 사용자에게 직접 보이지 않는 작업을 수행한다.
    애플리케이션을 꺼도 백그라운드 서비스는 계속 수행할 수 있다.

2) 바인더

    바인딩을 위한 서비스이다.
    여러 구성 요소(예를 들면 Acticity)를 서비스에 바인딩하여 서비스와 상호작용할 수 있다.
    액티비티와 서비스는 따로 운영될 수 있지만 서로 바인딩하여 통신할 수도 있다.
    bindService()를 호출하여 사용한다.
    바인딩이 해제되면 해당 서비스는 소멸된다.

3) 포그라운드

    서비스는 포그라운드로도 실행할 수 있다.
    포그라운드는 사용자에게 직접 보이는 작업을 수행한다.
    사용자가 다른 앱을 사용중이어도 계속해서 실행된다.

### 서비스의 선언

서비스는 activity처럼 Manifest에서 application의 하위 요소로 선언한다.

```xml
<manifest>
   <application>
      <service android:name=".MyService"/>
   </application>
</manifest>
```

### 서비스 생명 주기 (Service LifeCycle)

<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FcsvOQo%2FbtqEmwgjKcm%2FGZLLDKs46ed0aVF09wGFv1%2Fimg.png" width="300px" />

#### onStartCommand
- 액티비티 같은 앱 컴포넌트가 startService()를 호출하면, 서비스는 실행되며(started), 그 서비스를 실행한 컴포넌트가 종료되어도 할 일을 모두 마칠 때까지 서비스는 종료되지 않는다. 
- 따라서 서비스가 할일을 다하여 종료시키고 싶다면, 서비스 내에서 stopSelf()를 호출하여 스스로 종료되도록 하거나, 다른 컴포넌트에서 stopService()를 호출하여 종료해야 한다.
- 액티비티 등의 앱 컴포넌트는 startService()를 호출함으로써 서비스를 실행할 수 있고, 이때 어떤 서비스를 실행할지에 대한 정보와 그 외에 서비스에 전달해야할 데이터를 담고 있는 인텐트를 인자로 넘길 수 있다. 그리고 서비스의 onStartCommand() 콜백 메소드에서 매개변수로 그 인텐트를 받는다.

#### onBind
- startService() 메소드 대신 bindService() 메소드를 통해 시작되는 서비스를 서비스 바인딩 (Service Bind 혹은 Bound Service) 라 한다.
- 마치 클라이언트-서버 와 같이 동작을 하는데 서비스가 서버 역할을 한다. 
	(액티비티는 서비스에게 어떠한 요청을 할 수 있고, 서비스로부터 요청에 대한 결과를 받을수 있음)
- 하나의 서비스에 다수의 액티비티 연결 가능하며, 서비스 바인딩은 연결된 액티비티가 사라지면 서비스도 소멸된다. (즉 백그라운드에서 무한히 실행되지는 않음)
- 클라이언트가 서비스와의 접속을 마치려면 unbindService() 를 호출한다.

## 김민수

### 서비스?

안드로이드 앱 구성요소 중 하나로 <u>백그라운드에서 작업</u>을 수행한다. 액티비티와는 달리 사용자 인터페이스를 제공하지 않는다. 백그라운드에서 실행하기 때문에, 액티비티와는 달리 다른 앱으로 전환하여도 그 작업을 유지하며 수행할 수 있다. 하지만 API 26+부터 <u>백그라운드 서비스의 사용이 제한</u>된다.

### 유형

- 포그라운드

  포그라운드 서비스는 상단 `notification`을 통해 사용자에게 서비스가 실행되고 있다는 것을 알린다. 예를 들어 음악 재생 앱을 실행하면 상단 상태표시줄에 음악 재생 아이콘과 알림 창에 재생 UI를 띄운다.

- 백그라운드

  백그라운드 서비스는 사용자에게 보이지 않는 작업을 수행한다.

- 바인드

  앱 구성요소가 `bindService()`를 호출하여 해당 서비스에 바인딩 할 수 있다. 이때 바인딩 된 서비스와 앱 구성요소는 서버-클라이언트 인터페이스를 통해 상호작용을 한다. 서비스는 자신의 앱 뿐만 아니라 다른 앱의 구성요소와도 바인딩 될 수 있다. 다만, 모든 바인딩이 해제되면 서비스는 소멸한다.

### 수명주기

서비스는 `started service`와 `bound service`로 유형을 나눌 수 있는데, 이에 따라 서비스의 수명 주기 콜백이 달라진다.

<img src="https://developer.android.com/images/service_lifecycle.png" width=600/>

서비스의 전체 수명은 `onCreate()`부터 `onDestroy()`까지이며 `onDestroy()`에서 사용한 리소스를 릴리즈하면 된다.

### 서비스 선언 및 실행

서비스는 액티비티와 마찬가지로 매니페스트에 선언해야 한다. 또한 보안 상, 명시적 인텐트를 사용하여 실행해야 하며 인텐트 필터는 선언하지 말아야한다. `android:exported`속성을 `false`로 설정하면 다른 앱에서 서비스를 사용하지 못한다.

- Started Service

  실행: 명시적 인텐트를 인자로 넣어 `Context#startService(Intent)`를 호출하면, 서비스는 `onStartCommand()` 메서드가 호출된다. 포그라운드 서비스 실행은 `Context#startForegroundService(Intent)`를 호출한다.

  종료: `Service#stopSelf()` 또는 `Context#stopService(Intent)`

- Bound Service

  실행: `Context#bindService(Intent, ServiceConnection, int)`를 호출하여 서비스를 바인드 한다. 이때 서비스에서는 `onBind()`메서드가 호출된다.

  종료: `bindService()`에서 사용한 ServiceConnection 구현체를 변수에 넣어 `Context#unbindServie(ServiceConnection)`를 호출한다.
  서비스에 연결된 모든 커넥션이 사라지면 `onUnbind()`가 호출되며, 시스템은 해당 서비스를 종료시킨다.

### 서비스와 스레드

서비스는 호스트의 메인 스레드에서 동작한다. 따라서 서비스 또한 ANR을 일으킬 수 있으며, 긴 작업이 필요하면 별도의 워커 스레드를 생성해 처리해야 한다. 서비스는 단지 시스템의 백그라운드에서 작업을 처리할 수 있는 컴포넌트일 뿐이다.


## 이수형

### Service

서비스는 백그라운드에서 동작하는 작업을 수행한다.
서비스를 실행한 앱을 다른 앱으로 전환하더라도 서비스에서 시작한 작업은 백그라운드에서 계속 실행된다.
이를 사용하지 않으려면 생명주기에서 처리가 필요함

### 필요 Method

- onStartCommand()
   - 서비스 시작을 요청할때 여기서 서 startService를  호출
   - 바인딩만 사용할 경우 구현하지 않아도 무방

- onBind()
   - 다른 구성요소가 서비스에 바인딩 되고자 할때 여기서 bindService를 호출
   - 여기서는 클라이언트가 서비스와 통신을 하기위해 사용할 인터페이스를 제공해야함
   - 항상 구현해야하는 메소드이지만 바인딩 허용을 안할시 null 을 return

- onCreate()
   - 서비스가 처음 생성되었을때 호출되어 일회성 설정
   - 서비스가 이미 실행되었을 경우 호출안함

- onDestroy()
   - 서비스를 소멸시킬때 호출

StartService로 서비스를 시작하면 stopService로 중단되거나 스스로 정지될때까지 유지
bindService로 서비스를 생성하면 바인딩 주기가 끝나면 소멸

### Service 유형

- foreground Service
   - 알림창에 서비스가 실행 중인것을 표시
   - 시스템에 의해 강제로 종료되지 않음

- background Service
   - 백그라운드에서 작업수행
   - 리소스 부족시 강제종료될수 있음

- bind Servie
   - 서비스와 서비스를 호출하는 앱이 bindService()를 호출하여 서버-클라이언트 형태로 상호작용
   - 여러 프로세스에서 같은 서비스에 바인딩하여 작업 가능

## 우지현

### Service (서비스)

- 백그라운드에서 오래 실행되는 작업을 수행할 수 있는 어플리케이션 컴포넌트
- UI를 제공하지 않는다.
- 또 다른 어플리케이션 컴포넌트가 서비스를 실행할 수 있으며, 사용자가 또 다른 어플리케이션으로 전환하더라도 백그라운드에서 계속해서 실행된다.
- 컴포넌트를 서비스에 바인드하여 서비스와 상호작용할 수 있으며, IPC도 수행할 수 있다.
- 서비스는 앱에서 오직 1개의 인스턴스만을 생성할 수 있다.
- 다른 앱에서도 사용 가능하지만 manifest에서 비공개로 선언하여 외부 앱으로부터 차단할 수 있다.
- 자신의 호스팅 프로세스의 메인 스레드에서 실행되므로 서비스가 CPU를 많이 사용하는 작업을 수행하거나 CPU를 차단하는 작업을 수행할 경우, 서비스 내에 새 스레드를 생성하여 따로 작업을 진행시켜 ANR을 방지해야 한다.

### Service 유형

#### Foreground Service

- 사용자에게 알림을 줄 수 있는 기능을 수행한다.
  - 예를 들면, 오디오 앱은 오디오 트랙을 플레이하기 위해 포그라운드 서비스를 사용한다.
- 포그라운드 서비스는 반드시 Notification을 표시해야 하며 사용자가 앱과 인터랙션이 발생하지 않아도 계속해서 작동한다.

#### Background Service

- 사용자에게 직접적으로 알려지지 않는 기능을 수행한다.
- 앱이 스토리지와 관련된 기능을 수행하는 서비스를 사용한다면, 보통 백그라운드 서비스이다.
- 앱이 API 레벨 26 이상인 경우, 앱 자체가 포그라운드에 있지 않을 때 시스템이 백그라운드 서비스 실행에 제한을 건다.
  - 이러한 경우, 앱은 scheduled job을 대체재로 사용해야 한다.

#### Bind Service

-  앱 컴포넌트가 bindService()를 호출하여 해당 서비스에 바인드되면 서비스는 바인드되었다고 한다.
- 바인드된 서비스는 클라이언트-서버 인터페이스를 제공하여 컴포넌트가 서비스와 상호작용하도록 해주며, 결과를 가져올 수도 있고, 이와 같은 작업을 여러 프로세스에 걸쳐 IPC로 수행할 수도 있다.
- 바인드된 서비스는 앱 컴포넌트가 해당 서비스에 바인드되어 있을 때만 실행된다.
- 여러 개의 컴포넌트가 서비스에 한꺼번에 바인드 될 수 있으나, 바인드된 모든 컴포넌트가 바인드를 해제하면 해당 서비스는 소멸된다.

### Manifest

```xml
<manifest ...>
	...
	<application ... >
		<service android:name=".ExampleService" />
		...
	</application>
</manifest>
```

[<service>](https://developer.android.com/guide/topics/manifest/service-element.html)

- 앱의 보안을 보장하려면 서비스를 시작하거나 바인드할 때 항상 명시적 인텐트를 사용하고 인텐트 필터는 선언하지 않도록 한다.
- 유저가 돌아가고 있는 서비스를 인지하지 못하거나 신뢰하지 못하면 서비스를 중지시킬 수도 있기 때문에 description attribute를 적어주는 것이 좋다.

### 수명주기

> 서비스는 Started Service, Bound Service 두 가지 방식으로 작동 가능하다. 서비스가 started 할 수도 있고 (나아가 무기한으로 실행) bound될 수도 있다는 것이다. 이는 두 가지 콜백 메서드 onStartCommand(), onBind() 구현에 달려있다.

<img src="https://developer.android.com/images/service_lifecycle.png" alt="Service LifeCycle" width="400" />

- 액티비티와는 달리 서비스 수명 주기 콜백은 반드시 슈퍼 클래스를 구현할 필요가 없다.
- Started Service와 Bound Service는 서로 결합해서 사용할 수도 있다.
  - 대표적인 예로 음악 재생 시 액티비티를 종료해도 음악이 나와야하는 경우는 Started Service, 홈 화면에서 음악 재생 액티비티로 가면 현재 듣고 있는 음악에 대한 정보가 나와야 하는데 이 경우는 Bound Service이다.
  - 또 네트워크로 파일을 다운로드 받고 있을 때 액티비티를 종료해도 다운로드는 계속되어야 하므로 Started Service이고 다시 액티비티로 돌아왔을 대 다운로드 진행 상황을 보여줘야 하는 부분은 Bound Service이다.

### Service 생성

#### Started Service

- 다른 컴포넌트가 startServie()를 호출하여 시작해서 그 결과로 서비스의 onStartCommand()가 호출되는 경우
- 서비스가 시작되면 이를 시작한 컴포넌트와는 독립적인 자신만의 수명주기를 가지며 해당 서비스는 백그라운드에서 무기한으로 실행될 수 있다.
- 작업이 완료되면 stopSelf()를 호출하여 스스로 알아서 중단하는 것이 정상이며 다른 컴포넌트가 stopService()를 호출하여 중단시킬 수도 있다.
- 다른 컴포넌트가 인텐트를 통해 필요한 데이터를 담아 서비스를 시작하면 전달된 인텐트를 onStartCommand() 메서드에서 수신한다.
- 가장 처음 startService()를 호출하면 onCreate(), onStartCommand()가 호출되고 그 이후로는 onStartCommand()만 호출된다.

#### Bound Service

바인딩하는 메서드는 다음과 같다.

```java
public abstract boolean bindService(Intent service, ServiceConnection conn, int flags)
```

- service는 대상 서비스, conn은 서비스와 연결되거나 끊겼을 때의 콜백, flags는 보통 BIND_AUTO_CREATE가 들어가는데, startService()를 통해 서비스를 실행하지 않았다면 넣어줘야 한다.
- BIND_AUTO_CREATE 옵션을 주고 stopService() 호출 시 서비스는 종료되지 않는다.
- unbindService()를 바운드된 곳마다 호출해야 한다.
- 바인딩을 제공하는 서비스를 생성할 때는 클라이언트가 서비스와 상호작용하는 데 사용할 수 있는 프로그래밍 인터페이스를 제공하는 IBinder를 제공해야 한다.

## 이유진
### Service

백그라운드에서 오래 실행되는 작업을 수행할 수 있는 애플리케이션 컴포넌트로, UI는 제공하지 않는다.

#### 특징

- 다른 앱의 구성요소가 서비스를 시작할 수 있고, 사용자가 앱을 전환해도 백그라운드에서 계속 실행된다.
- 컴포넌트를 서비스에 바인딩하여 서비스와 상호작용 할 수 있다.
- 프로세스 간 통신(IPC)을 수행할 수 있다.
- 매니페스트 파일에 선언해야한다.

### 서비스의 유형

- 포그라운드
    - `startForeground()` 를 호출해서 실행을 요청한다. 제거시 `stopForeground()`
    - 알림을 표시해야 한다. (foreground → 사용자에게 실행하고 있는 게 보인다.)
    - 사용자가 앱과 상호작용하지 않을 때도 계속 실행된다.
- 백그라운드
    - 사용자에게 직접 보이지 않는 작업을 수행한다.
    - 백그라운드 작업은 앱의 제한된 리소스를 사용하기 때문에 Android 8.0(API 26)부터는 사용자 환경을 개선하기 위해 백그라운드에서 실행되는 작업을 제한한다.
- 바인드
    - 바인딩을 위한 서비스. 여러 구성 요소를 서비스에 바인딩하여 서비스와 상호작용하게 해준다.  이런 작업을 여러 프로세스에 걸쳐 IPC로 수행할 수도 있다.
    - 앱 컴포넌트가 `bindService()` 를 호출하여 해당 서비스에 바인드되면 서비스가 바인딩된다.
    - 바인딩된 모든 클라이언트로부터 바인딩이 해제되면 해당 서비스는 소멸된다.

### 서비스 주요 콜백 메서드

> Service의 하위 클래스를 생성해야 한다. 구현을 위해 서비스 생명주기의 몇 가지 콜백 메서드를 재정의해야한다.
> 
- onStartcommand()
    - 이 메서드가 실행되면 서비스가 시작되고 백그라운드에서 무한히 실행될 수 있다. by `startService()`
    - 중단도 개발자가 한다. `stopSelf()` , `stopService()`
- onBind()
    - 다른 구성 요소가 해당 서비스에 바인딩되고자 할 경우 이 메서드를 호출한다. `bindService()`
    - `IBinder` 을 반환하여 클라이언트가 서비스와 통신을 할 수 있게 인터페이스를 제공한다.
- onCreate()
    - 서비스가 `onStartcommane()` 나 `onBind()` 를 호출하기 전에 이 메서드를 호출하여 일회성 설정 절차를 수행한다.
    - 이미 실행 중인 경우엔 호출되지 않는다.
- onDestroy()
    - 서비스를 소멸시킬 때 호출한다.
    - 각종 리서스를 정리한다.

### Started Service

- 다른 구성 요소가 `startService()` 를 호출하여 시작하고, 그 결과로 서비스의 `onStartCommand()` 메서드가 호출되는 경우
- 자신의 생명주기를 직접 관리해야 한다. 시스템이 서비스를 중단하거나 소멸시키지 않으므로 스스로 중지하거나 `stopSelf()` 다른 컴포넌트가 중지시켜줘야한다. `stopService()`

### Bound Service

- 한 구성 요소에서 `bindService()` 를 써서 서비스를 호출하면 해당 서비스는 해당 구성 요소가 바인딩된 경우에만 실행된다.
- 모든 바인딩이 해제되면 소멸한다.
