# 프래그먼트, 생명주기, 프래그먼트 매니저

## 김현수

### 프래그먼트란?
- 앱의 전체 UI에서 어딘가에 반복적으로 재사용 가능한 부분
- 프래그먼트는 자체 레이아웃(xml파일을 정의할 수 있음)을 가질 수 있으며 자체 생명 주기를 보유한다. 또한 자체 입력 이벤트를 받으며 처리할 수 있습니다.(자체 레이아웃을 갖는 것은 선택 사항, 자체 UI가 없는 프래그먼트도 만들 수 있음)
- 프래그먼트는 독립적으로 존재할 수 없고, 반드시 Activity나 다른 프래그먼트에 호스팅되어야 한다.
	> 호스팅(hosting) = 주인 역할을 하다 / 호스팅되다 = 노예가 되다
- 따라서 프래그먼트의 뷰 계층 구조는 호스트 뷰 계층 구조의 일부가 된다.

### Activity와 프래그먼트의 서로 다른 목적성
- Activity : 앱 전체적인 사용자 인터페이스(UI)에 포함될 요소들을 배치하는 곳
- 프래그먼트 : 단일 화면이나 화면 일부에 관한 사용자 인터페이스(UI)를 정의하는데 적합하다.

### 프래그먼트의 생명주기

#### 1. Activity State : Created (액티비티 생성 시)
- onAttach()
	- Fragment가 Activity에 '붙을 때' 호출된다.
	- 자원을 가져다 쓸때 onAttach()를 오버라이드하여 사용한다.

	```java
	//Fragment에서 부모 액티비티 저장하는 법
	public void onAttach(Context context){
	   super.onAttach(context)
	   if(context instanceof MainActivity){
		  mParent = (MainActivity)context;
	   }
	}
	```

- onCreate()
	- 이 Fragment가 사용할 리소스를 초기화 한다. (UI초기화는 아님!)

- onCreateView()
	- Layout inflate와 UI를 초기화 한다.
	> - ( inflater -> 뷰를 그려주는 역할/ container -> 부모 뷰 )
	- Fragment가 인터페이스를 처음으로 그릴 때 호출된다.
	- 부모 액티비티의 onCreate()를 호출 후 실행된다.
	- 이때, 부모 액티비티의 onCreate()가 아직 끝나지 않았으니 View를 바꾸면 안된다.

- onActivityCreated()
	- 부모 액티비티의 onCreate() 종료 후 실행된다.
	- Fragment ,Activity 모두 View 생성이 완료된 상태이니 부모 액티비티의 View를 바꾸려면 여기서 바꾸면 된다.

위 onCreate()와 onCreateView(), onActivityCreated()는 최소한으로 구현해야 하는 3개의 생명 주기 메서드다.

#### 2. Activity State : Started (액티비티 생성 시)
- onStart()
	- Fragment가 화면에 표시될 때 호출된다.
	
#### 3. Activity State : Resumed (액티비티 재개 시)
- onResume()
	- Fragment가 로딩이 끝나 화면에 완전히 보였을 때 호출된다.
	
#### 4. Activity State : Paused (액티비티 일시중지 시)
- onPause()
	- 화면이 중지되면 호출된다.

#### 5. Activity State : Stopped (액티비티 중지 시)
- onStop()
	- Fragment가 종료되는 과정에서 호출된다.

#### 6. Activity State : Destroyed (액티비티 파괴 시)
Fragment를 삭제하는 경우 실행되는 함수이다.

- onDestroyView()
	- Fragment가 있던 자리에 다른 Fragment가 대체될 때 실행된다. Fragment의 View를 제거한다.

- onDestroy()
	- 리소스를 제거한다.
	- 어플이 종료되거나, 절전모드 등으로 화면이 꺼지거나, 다른 어플을 실행하는 등의 상황에 실행된다.

- onDetach()
	- 액티비티로부터 분리될 때 실행된다.

### FragmentManager
- FragmentManager은 백 스택(Back Stack) 에 프래그먼트 추가/교체/삭제 작업에 의한 변경 사항을 push 및 pop 하는 작업을 담당하는 클래스

- 하는 일
	1. 프래그먼트 트랜잭션
	프래그먼트를 추가, 삭체, 교체 등의 작업을 수행할 수 있게 해주며, 행해진 트랜잭션의 상태를 프래그먼트 백스택에 저장할 수 있도록 해준다.

	2. 액티비티와의 통신
	단일 프래그먼트에 대해 세부적인 작업 또한 가능하다. 프래그먼트 내의 구성요소들 하나하나에 접근 할 수 있도록 해준다. <br>
  액티비티에서 특정 이벤트가 발생했을 때, 프래그먼트에서 적절한 동작을 할 수 있도록 한다.
  
  ## 김민수

### 프래그먼트

프래그먼트는 `FragmentActivity` 내의 사용자 인터페이스 중 하나이다. 하나의 액티비티에서 여러 개의 프래그먼트를 사용할 수 있으며, 프래그먼트는 여러 액티비티에서 재사용될 수 있다. 프래그먼트는 자신의 수명주기를 갖고 있으며 항상 **액티비티에 종속되어 동작**한다. 따라서 프래그먼트는 부모 액티비티의 수명주기에 영향을 받는다. 프래그먼트는 `FragmentActivity`의 `getSupportFragmentManager()`로 리턴받은 프래그먼트매니저를 통해 관리된다.

- 프래그먼트는 같은 앱에서 서로 다른 크기의 화면을 갖는 기기에서 유연한 UI를 제공하기위해 만들어 졌다.

- 프래그먼트는 다른 액티비티에서 사용될 수 있으므로 프래그먼트가 다른 프래그먼트를 직접 조작하는 것을 지양해야 한다.
- API 28부터는 Jetpack 라이브러리의 프래그먼트를 사용한다.

#### 수명주기

<img src="https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png" style width="600"/>

-  프래그먼트 자체의 수명주기 상태 (상태 전환 이벤트 발생)

- 그에 따른 프래그먼트의 콜백

- onCreateView()에서 리턴한 View의 수명주기 상태

  프래그먼트의 수명주기가 변화되는 순간 콜백을 호출하고, 콜백 함수가 종료되는 시점에 View의 수명주기에 이벤트를 전달한다.

#### onCreate()

프래그먼트만 먼저 CREATED인 상태로, 프래그먼트매니저에 add 되었을 때 onCreate()를 호출한다. 이 시점에서는 Fragment의 View가 아직 생성되기 전이므로, View에 대한 작업은 하지 말아야 한다. 

onCreate()의 인자로 onSaveInstanceState()에서 저장된 savedInstancestate: Bundle?이 전달된다. 처음 생성될 땐, null이 전달된다.

#### onCreateView(), onViewCreated()

onCreateView()를 오버라이딩 하여 View를 생성할 수도 있고, LayoutId를 인자로 넘기는 생성자를 이용하여 View를 생성할 수도 있다.

``` java
@ContentView
public Fragment(@LayoutRes @NonNull int contentLayoutId)
```

생성된 View는 onViewCrated()의 인자로 전달되고, View에 관한 작업을 작성한다.

#### onViewStateRestored()

저장되어있던 state가 모두 View에 반영되었을 때 호출된다. 이 메서드는 state를 바탕으로 View 계층을 추적하여 초기화 하는데 사용한다.

- checkbox 체크 여부 등을 확인할 수 있다

#### onStart()

프래그먼트가 사용자에게 보여질 때 호출된다. 호스트 액티비티의 onStart()의 호출 시점과 유사하다. 이 때부터 프래그먼트 매니저로부터 트랜잭션을 수행할 수 있다.

#### onResume()

프래그먼트가 사용자와 상호작용이 가능할 때 호출된다. 즉, onResume() 이전에 사용자의 입력이나 포커스를 설정하는 등의 작업을 수행하면 안된다.

#### onPause()

프래그먼트가 포커스를 잃었을 때 호출되며, 프래그먼트는 사용자에게 보여진 상태를 유지한다. 이때 프래그먼트의 상태는 액티비티와는 다르게 RESUMED 에서 STARTED로 다시 바뀐다.

#### onStop()

프래그먼트가 화면에 보이지 않는 상태가 되면 STARTED 에서 CREATED로 상태가 변화하고 그 콜백으로 onStop()이 호출된다. 호스트 액티비티나 프래그먼트가 중단되었을 때 또는 상태가 저장될 때도 호출된다.

<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbC4Zkm%2Fbtq9DwbxrgQ%2FIl287fhextuJbiCRZtZde1%2Fimg.png" style width="600"/>

API 28부터 프래그먼트의 상태를 저장하는 onSaveInstanceState()의 호출 시점이 바뀌었다. 따라서 onStop()까지 트랜잭션을 안전하게 수행할 수 있다.

#### onDestroyView()

프래그먼트의 View가 프래그먼트로 부터 떨어질 때 호출된다. 프래그먼트가 다시 보여져야 할 경우, 새로운 View가 생성된다. 

#### onDestroy()

프래그먼트가 더 이상 사용되지 않을 때 (백스택에서도 제거되었을 때) 호출된다.

#### 프래그먼트 전환과정

A fragment에서  B fragment로 전환

1. A: onPause(), onStop()
2. B: onAttach(), onCreate()...onStart()
3. A: onDestroyView(), onDestroy(), onDetach()

### 프래그먼트 매니저

액티비티와 프래그먼트, 혹은 프래그먼트와 그 내부 프래그먼트 사이에서 서로 간의 상호작용을 이어주는 역할을 한다. 

- 프래그먼트들을 add, remove, replace 하는 트랜잭션
- 트랜잭션으로 인한 백스택 관리
- 각 하위 프래그먼트의 구성요소에 접근

#### 접근 방법

- FragmentActivity는 getSupportFragmentManager()를 호출하여 프래그먼트 매니저를 받을 수 있다.

- 프래그먼트에서 자신을 호스트한 매니저는 getParentFragmentManager()로 접근 가능하다.
- 프래그먼트에서 자식 프래그먼트를 관리하는 매니저는 getChildFragmentManager()로 접근 가능하다.
