# ANR, 발생 시 대처 방법

## 김민수

### ANR

Application Not Responding의 약자로 애플리케이션이 반응하지 않을 때 발생한다. 앱의 메인 스레드(UI 스레드)가 일정시간 어떤 작업에 묶여 있으면 사용자의 입력처리를 할 수 없고 사용자는 앱이 응답하지 않는 경험을 한다.

### ANR 발생 요인

안드로이드 시스템은 아래 두가지 조건 중 하나를 감지하면 ANR 대화상자를 띄운다.

- 입력 이벤트(터치, 키 입력)에 대해 5초 이내에 응답하지 않음

- 브로드캐스트 리시버가 10초 이내에 실행을 완료하지 못함

  > 브로드캐스트 리시버, 서비스의 기본 동작도 메인 스레드에서 이뤄진다. 다만 서비스는 서브 스레드에서 구현된다.


### ANR 회피 및 대처 방법

1. 장시간 작업이 필요한 경우, 메인 스레드 외 다른 스레드에서 비동기 처리를 해야한다.

   - 워커 스레드 생성

   - AsyncTask 사용

   - Coroutine 사용

2. 사용자에게 작업의 진행 과정을 안내하여(프로그레스 바, 로딩 ui) 기다리게 한다.
   - 워커 스레드에서 메인 스레드로 UI 작업 전달
     - 메인 스레드의 핸들러로 Runnable 전달
     - Activity.runOnUiThread(Runnable)
     - View.post(Runnable)
   - AsyncTask의 `onProgressUpdate()`를 구현하고 `publishProgress()` 호출
   - IO 스코프에서 장기 작업을 진행하고 Main 스코프에서 UI 작업 실행

## 김현수

### ANR이란?
ANR은 Application Not Responding의 약자로 '애플리케이션이 응답하지 않는다'는 뜻이다. Main Thread(UI Thread)가 일정 시간 어떤 Task에 잡혀 있으면 발생하게 된다.

### ANR의 발생 원인

- 애플리케이션이 UI 스레드에 어떠한 I/O 명령(빈번한 네트워크 액세스)으로 인해 막힐 때
- 너무 많은 시간을 정교한 메모리 구조를 구축하는데 들일 때
-  Android Developers 에서는 아래와 같이 명시한다.
	```
	- Input 이벤트(키를 누르거나 화면을 터치하는 등)에 5초안에 반응을 하지 않을 때
	- BroadcatReceiver 가 10초내로 실행을 끝내지 않을 때
	```

### ANR 예방 설계
- 시간이 많이 걸리는 작업은 서브스레드에서 동작하도록 하여 메인스레드의 부하를 줄인다.
	- 서브스레드에서 시간이 오래걸리는 작업을 수행하고 Handler를 이용하여 작업상태 메시지를 메인스레드에 전달한다.
	- AyncTask를 이용하여 핸들러 사용없이 작업과 작업에 대한 내용을 실시간으로 UI에 업데이트한다.
	- RxJava의 스케쥴러를 이용하여 서브스레드에서 작업한다.
- 사용자에게 프로그레스바 등을 이용해 작업의 진행 과정을 안내해 기다리도록 한다.

## 우지현

### ANR

Activity에서 사용자 이벤트가 발생하고 5초 이내에 처리하지 못할 경우 안드로이드 시스템이 액티비티를 강제 종료하는 것을 Application Not Responding이라고 한다. 주로 오래 걸리는 작업 결과를 이용해 화면 UI를 수정하려고 할 때 발생하며, 특히 네트워크가 안 좋은 환경에서 통신을 수행할 때 자주 발생한다.

### ANR 해결방법

오래 걸릴 가능성이 있는 작업은 Activity에서 처리하지 말고, 별도의 스레드를 만들어서 병렬로 처리하도록 한다. 그렇게 하면 데이터 수신 등의 오래 걸리는 작업은 별도의 스레드에서 돌아가므로 Activity는 사용자 이벤트에 5초 이내에 반응할 수 있게 되어 ANR이 발생하지 않게 된다. 작업이 완료되었다면 UI 수정은 UI 스레드에게 요청해서 처리한다.

#### UI 스레드에 화면 작업 요청하는 방법

- Handler 클래스
  - Handler 클래스의 post(), sendMessage() 메서드 등을 활용하여 UI스레드에게 화면 작업 요청
- AsyncTask 클래스 상속
  - AxynkTask를 상속받는 클래스를 생성하여 아래 메서드를 오버라이딩하고, 해당 클래스의 객체를 생성하여 execute()로 호출하면 된다.
  - doInBackground()
    - 백그라운드에서 오래 걸리는 작업을 수행하며 화면 뷰에 접근할 수 없다. 아래의 2가지 방법으로 데이터를 전달한다.
      - publishProgress(데이터) : onProgressUpdate()에 데이터를 넣어 호출
      - return 데이터 : onPostExecute()에 데이터를 넣어 호출한다.
  - onProgressUpdate()
    - doInBackground() 메서드에서 publishProgress() 호출 시 콜백되는 메서드로 화면 뷰에 접근할 수 있다.
  - onPostExecute()
    - doInBackground() 메서드에서 return 시 콜백되는 메서드로 화면 뷰에 접근할 수 있다.

## 이유진
### ANR (Android Not Working)
Android 앱의 **UI스레드가 오랫동안 차단되면 `ANR(어플리케이션 응답 없음)`오류가 트리거**된다. ANR은 UI 업데이트를 담당하는 앱의 기본 스레드가 사용자의 입력 이벤트를 처리하지 못해 불만을 초래한다. 따라서 앱에 응답성을 설계하여 시스템이 사용자에게 ANR 대화상자를 표시하지 않도록 하는 것이 중요하다.
> 앱이 다른 작업을 수행하느라 입력 이벤트나 인텐트 브로드캐스트를 처리할 기회를 제공하지 않게 된다.

![](https://developer.android.com/images/anr.png?hl=ko)

#### 발생 원인
- 앱이 입력 이벤트 또는 BroadcastReceiver에 5초 이내로 응답하지 않는 경우
  - 가장 나중에 입력된 이벤트 기준으로 5초 이내에 응답하지 않으면 발생한다.
  - 예를들어, `12시 00분 5초`에 A이벤트 발생, `12시 00분 8초`에 B이벤트가 발생했고 아무 응답이 없다면, `12시 00분 10초`가 아닌 `12시 00분 13초`에 ANR이 발생한다!<br>프로그램이 응답하지 않을 때, 입력을 한 번 더 하면 그제서야 '응답없음 대화상자'가 뜨는 이유다. 
- 포그라운드에 활동이 없을 때 BroadcastReceiver가 10초 내에 실행을 완료하지 못한 경우

### ANR 피하는 방법
- `UI 스레드`에서 실행되는 메서드는 가능한 한 작업을 적게 실행해야 한다.
  - 특히 activity는 `onCreate()`나 `onResume()`과 같은 주요 생명주기 메서드에서 처리하는 작업을 가능한 줄여야 한다. (라고 해석했는데 맞겠죠...?)
  - 네트워크나 DB작업, 비트맵 크기 조정과 같이 긴 시간이 소요될 가능성이 있는 작업은 `Worker thread`에서 실행해야 한다. (db작업은 비동기식 요청으로)

### 그 외 응답성 강화 방법
일반적으로 100-200ms은 사용자가 앱의 속도 저하를 감지하는 임계값이다. 따라서 ANR을 피하고 앱이 적절한 속도로 사용자에게 응답하도록 하기 위해 추가적으로 할 작업은 다음과 같다.
- 사용자 입력에 대한 응답으로 백그라운드 작업을 실행하는 경우 진행 상황을 보여준다. (ex. `ProgressBar`)
- 앱의 초기 설정 단계가 있는 경우 `Splash` 화면을 표기하거나, 기본 화면을 가능한 빨리 렌더링하고 로딩중임을 나타내며 비동기로 화면을 채운다. (=> 네이버 기본앱의 메인화면이 검색창만 있는 것으로 바뀐 이유라 생각한다.)
- 중요한 것은 어떤 경우든 **앱이 멈추지 않았음을 사용자가 인지할 수 있게 진행 상황을 표시하는 것**이다.
- 성능 도구(Systrace, Traceview)를 사용하여 앱 응답성의 병목 현상을 확인한다.
