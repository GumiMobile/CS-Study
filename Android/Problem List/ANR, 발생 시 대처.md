# ANR, 발생 시 대처 방법

## 김민수

### ANR

Application Not Responding의 약자로 애플리케이션이 반응하지 않을 때 발생한다. 앱의 메인 스레드(UI 스레드)가 일정시간 어떤 작업에 묶여 있으면 사용자의 입력처리를 할 수 없고 사용자는 앱이 응답하지 않는 경험을 한다.

### ANR 발생 요인

안드로이드 시스템은 아래 두가지 조건 중 하나를 감지하면 ANR 대화상자를 띄운다.

- 입력 이벤트(터치, 키 입력)에 대해 5초 이내에 응답하지 않음

- 브로드캐스트 리시버가 10초 이내에 실행을 완료하지 못함

  > 브로드캐스트 리시버, 서비스의 기본 동작도 메인 스레드에서 이뤄진다. 다만 서비스는 서브 스레드에서 구현된다.


### ANR 회피 및 대처 방법

1. 장시간 작업이 필요한 경우, 메인 스레드 외 다른 스레드에서 비동기 처리를 해야한다.

   - 워커 스레드 생성

   - AsyncTask 사용

   - Coroutine 사용

2. 사용자에게 작업의 진행 과정을 안내하여(프로그레스 바, 로딩 ui) 기다리게 한다.
   - 워커 스레드에서 메인 스레드로 UI 작업 전달
     - 메인 스레드의 핸들러로 Runnable 전달
     - Activity.runOnUiThread(Runnable)
     - View.post(Runnable)
   - AsyncTask의 `onProgressUpdate()`를 구현하고 `publishProgress()` 호출
   - IO 스코프에서 장기 작업을 진행하고 Main 스코프에서 UI 작업 실행

## 김현수

### ANR이란?
ANR은 Application Not Responding의 약자로 '애플리케이션이 응답하지 않는다'는 뜻이다. Main Thread(UI Thread)가 일정 시간 어떤 Task에 잡혀 있으면 발생하게 된다.

### ANR의 발생 원인

- 애플리케이션이 UI 스레드에 어떠한 I/O 명령(빈번한 네트워크 액세스)으로 인해 막힐 때
- 너무 많은 시간을 정교한 메모리 구조를 구축하는데 들일 때
-  Android Developers 에서는 아래와 같이 명시한다.
	```
	- Input 이벤트(키를 누르거나 화면을 터치하는 등)에 5초안에 반응을 하지 않을 때
	- BroadcatReceiver 가 10초내로 실행을 끝내지 않을 때
	```

### ANR 예방 설계
- 시간이 많이 걸리는 작업은 서브스레드에서 동작하도록 하여 메인스레드의 부하를 줄인다.
	- 서브스레드에서 시간이 오래걸리는 작업을 수행하고 Handler를 이용하여 작업상태 메시지를 메인스레드에 전달한다.
	- AyncTask를 이용하여 핸들러 사용없이 작업과 작업에 대한 내용을 실시간으로 UI에 업데이트한다.
	- RxJava의 스케쥴러를 이용하여 서브스레드에서 작업한다.
- 사용자에게 프로그레스바 등을 이용해 작업의 진행 과정을 안내해 기다리도록 한다.

## 우지현

### ANR

Activity에서 사용자 이벤트가 발생하고 5초 이내에 처리하지 못할 경우 안드로이드 시스템이 액티비티를 강제 종료하는 것을 Application Not Responding이라고 한다. 주로 오래 걸리는 작업 결과를 이용해 화면 UI를 수정하려고 할 때 발생하며, 특히 네트워크가 안 좋은 환경에서 통신을 수행할 때 자주 발생한다.

### ANR 해결방법

오래 걸릴 가능성이 있는 작업은 Activity에서 처리하지 말고, 별도의 스레드를 만들어서 병렬로 처리하도록 한다. 그렇게 하면 데이터 수신 등의 오래 걸리는 작업은 별도의 스레드에서 돌아가므로 Activity는 사용자 이벤트에 5초 이내에 반응할 수 있게 되어 ANR이 발생하지 않게 된다. 작업이 완료되었다면 UI 수정은 UI 스레드에게 요청해서 처리한다.

#### UI 스레드에 화면 작업 요청하는 방법

- Handler 클래스
  - Handler 클래스의 post(), sendMessage() 메서드 등을 활용하여 UI스레드에게 화면 작업 요청
- AsyncTask 클래스 상속
  - AxynkTask를 상속받는 클래스를 생성하여 아래 메서드를 오버라이딩하고, 해당 클래스의 객체를 생성하여 execute()로 호출하면 된다.
  - doInBackground()
    - 백그라운드에서 오래 걸리는 작업을 수행하며 화면 뷰에 접근할 수 없다. 아래의 2가지 방법으로 데이터를 전달한다.
      - publishProgress(데이터) : onProgressUpdate()에 데이터를 넣어 호출
      - return 데이터 : onPostExecute()에 데이터를 넣어 호출한다.
  - onProgressUpdate()
    - doInBackground() 메서드에서 publishProgress() 호출 시 콜백되는 메서드로 화면 뷰에 접근할 수 있다.
  - onPostExecute()
    - doInBackground() 메서드에서 return 시 콜백되는 메서드로 화면 뷰에 접근할 수 있다.

