# 메인 스레드와 워커 스레드

## 김민수

안드로이드에는 메인 스레드와 워크 스레드가 있다. 이 두 스레드는 각각 다른 목적으로 사용된다.

### 메인 스레드(UI 스레드)

어플리케이션을 실행하면 기본적으로 작업이 실행되는 <u>단일 스레드</u>이며 <u>유일하게 UI 변경</u>을 실행 할 수 있다. 만약 메인스레드에서 오래걸리는 작업을 수행한다면 메인 스레드는 블락되고(단일 스레드) 사용자는 화면이 멈춰있는 경험을 한다. 또한 안드로이드 시스템에서 5초 이상 앱이 반응하지 않으면 `ANR(Application Not Responding)` 에러를 발생시킨다. 따라서 네트워크 통신이나, db 작업 등 오래 걸리는 작업은 반드시 다른 스레드에서 처리(API 11+)해야 한다.



> 메인 스레드 != UI 스레드
>
> 엄밀히 말하면 메인 스레드와 UI 스레드는 정확히 같다고 할 수 없다. OS의 일부분으로 실행되는 앱에서는 두 스레드의 구별이 중요하다. 하지만, 커스텀 롬을 구축하거나, 휴대전화 제조사와 같이 안드로이드 커스터마이징을 하지 않는 이상 두 스레드는 구분하지 않는 것이 일반적이다.
>
> 메인 스레드의 초기화
>
> - `android.app.ActivityThread`클래스의 `public static void main(String[])`가 실행되고 여기서 `ActivityThread thread = new ActivityThread()`로 할당
>
> - `ActivityThread`의 `systemMain()`메서드에서 메인 스레드 초기화
>
> UI 스레드의 초기화
>
> - `android.app.Activity`의 `attach()` 에서 `mUiThread = Thread.currentThread()`로 초기화



### 워커 스레드

UI 스레드를 블락하지 않기 위해서, 긴 시간이 필요한 작업의 경우(네트워크 통신, db작업) 별도의 스레드에서 수행해야 한다. 이때 사용하는 스레드가 워커 스레드이다. 그러나 워커 스레드에서 UI변경 작업을 수행하면 `android.view.ViewRootImpl$CalledFromWrongThreadException`이 발생한다. 따라서 UI 작업은 메인 스레드에게 요청해야 한다.

- `Activity.runOnUiThread(Runnable)`
- `View.post(Runnable) or postDelayed(Runnable, long)`
- `Handler(Looper.getMainLooper()).post(Runnable) or postDelayed(Runnable, long)`

``` kotlin
fun onClick(v: View) {
    Thread(Runnable {
        // a potentially time consuming task
        val bitmap = getBitMapFromServer("image.png")
        imageView.post {
            imageView.setImageBitmap(bitmap)
        }
    }).start()
}
```

위 세가지 방법 모두 메인 스레드에게 Runnable 객체로 UI변경 작업을 보내는 방법이다.
