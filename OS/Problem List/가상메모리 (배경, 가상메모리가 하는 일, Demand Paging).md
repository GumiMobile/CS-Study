# 가상메모리 (배경, 가상 메모리가 하는 일, Demand Paging)

## 김민수

### 가상 메모리

#### 가상메모리란?

메모리를 관리하는 방법의 하나로, 실제 물리 메모리가 아닌 가상의 메모리를 말한다. 멀티 태스킹 운영 체제에서 흔히 사용되며, 실제 메인 메모리의 용량보다 큰 영역을 제공한다.

#### 배경

과거 저장 매체는 아주 작은 용량을 가졌다. 실제 메모리보다 큰 용량을 갖는 프로그램을 실행하면 메모리 부족 오류가 날 것이다. 즉, 메모리 용량은 시스템 내의 최대 크기의 프로그램보다 커야한다. 이런 제한 사항으로 인해 엔지니어들은 프로그램을 실행하는데 필요한 최소한의 메모리에 중점을 두고 가상 메모리를 개발했다. 메모리 접근은 지역성으로 인해, 10000 바이트의 프로그램을 실행하는데 실제로 필요한 용량은 10000 바이트 보다 적다. 결국, 실제 프로그램을 실행하는데 필요한 데이터만 메모리에 할당한다면 프로그램 전체 크기의 공간이 필요치 않다. 실행에 필수적인 데이터 이 외에 나머지는 백킹 스토어에 위치하고 이것을 가상 메모리 기법이라 한다.

#### 가상 메모리의 장점

- 메모리의 확장성 부여

  물리적 메모리는 한정적이지만, 가상 메모리는 훨씬 큰 공간으로 구성가능하다.

- 모든 프로그램에 동일한 메모리공간 제공

  개발자 입장에서 물리적 메모리가 아닌 OS가 제공하는 메모리 공간만 고려하면 된다. 실제 메모리 할당은 운영체제가 수행할 것이다.

- 메모리 할당과 관리의 효율성

  물리적으로 연속되지 않은 메모리 공간이라도 가상으로 연속적인 메모리 공간으로 사용가능하다

#### Demand Paging

실제로 필요할 때 page를 메모리에 올리는 것이다. 필요한 데이터만 메모리에 올라가 있어 I/O의 양, 메모리 사용량이 감소하고 더 많은 사용자를 수용할 수 있다. 

![image](https://user-images.githubusercontent.com/80962918/136775951-5bfb2123-6b79-4209-876e-4d2ad11d2997.png)

- valid - invalid bit
  - 페이지 테이블의 bit가 valid면 실제 메모리에 해당 페이지가 올라가 있다.
  - 백킹 스토어에 내려가 있으면 invalid이다.

- Page fault
  - invalid page에 접근하면 MMU가 page fault trap을 발생시킨다.
  - 커널 모드로 전환되고 page fault handler가 호출 된다.
  - Page fault 실행과정
    1. invalid라면 커널 모드로 전환되어 프로세스를 운영체제가 점유한다.
    2. 빈 페이지 프레임을 찾는다. 없다면 페이지 프레임을 교체한다.
    3. 해당 페이지를 백킹스토어(디스크)에서 메모리로 읽어온다.
       1. 디스크 IO가 끝날 때 까지 cpu는 다른 프로세스로 넘어간다.
       2. IO가 끝나면 메모리에 페이지를 올리고 page table의 bit를 바꾼다.
       3. 레디 큐에 프로세스를 넣는다.
    4. 이 프로세스가 cpu를 점유하고 running 상태로 바뀐다.
    5. 중단되었던 instruction을 재개한다.
- Performance
  - Page fault rate P = (0, 1). 0에 가까울 수록 page fault가 나지 않는다.
  - Effective Access time = (1 - P) * memory access + P * (OS & HW page fault overhead+ 페이지 스왑 인(필요하다면 스왑 아웃까지) + OS & HW restart overhead)


## 이수형

### 가상 메모리

실제 존재하지는 않지만 프로그램을 메모리에 올리기위해 가상적으로  실제 메모리 주소가 아닌 가상의 메모리 주소를 주는 방식<br/>

옛날에는 RAM에 프로그램 전체를 적재했는데 RAM 크기보다 큰 프로그램을 실행할 수 없고 프로그램 실행시 다른작업을 할수 없었음<br/>

그래서 실행에 필요한 메모리만 실제로 올리고 나머지는 가상의 메모리 주소를 할당하여 가상 메모리가 등장<br/>

실제 필요한 메모리는 MMU가 mapping한다.

Demand Paging

대부분의 프로그램이 프로그램 전체가 메모리에 올라와있지 않아도 사용가능하다는 특징을 사용<br/>

요구 페이징은 프로세스의 이미지를 backing store(페이지를 임시로 보관하는곳)에 저장한다. <br/>

프로세스는 페이지의 조합이기 때문에 필요한 페이지만 메모리에 올리고 다른 페이지는 보조기억장치에 올려 사용한다<br/>

이때 페이지 테이블은 메인 메모리에 적재되어 있는지 backing store에 있는지를 구분해주는것이  valid 비트이다

> 메인 메모리에 있는 페이지 : 
> CPU가 요구할 시 페이지 테이블을 따라 실행

> backing store에 있는 페이지 : 
> CPU의 동작을 멈추고 운영체제가 backing store에서 페이지를 찾아 메인 메모리에 적재를 시키고 valid비트를 바꾸어주는 작업을 수행
